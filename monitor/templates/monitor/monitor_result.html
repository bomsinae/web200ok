{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <div class="h5">
    {% if http %}
    {{ http.label }} 모니터링 결과
    {% else %}
    전체 모니터링 결과
    {% endif %}
  </div>
  <div>
    <button class="btn btn-sm btn-outline-danger" id="btn_abnormal_toggle">
      {% if request.GET.abnormal_only %}전체 보기{% else %}오류/비정상만 보기{% endif %}
    </button>
  </div>
</div>
<div>
  <div class="d-none d-lg-block">
    <div class="row article-list-head py-2 m-0 rounded">
      <div class="col-lg-8">
        <div class="row">
          <div class="col-2 px-3">Account</div>    
          <div class="col-3 px-3">Label</div>    
          <div class="col px-3">URL</div>    
        </div>
      </div>
      <div class="col-lg-4">
        <div class="row">
          <div class="col text-center text-nowrap">상태</div>
          <div class="col text-center text-nowrap">응답코드</div>
          <div class="col text-center text-nowrap">응답시간</div>
          <div class="col-3 text-nowrap text-center">검사일시</div>
        </div>
      </div>
    </div>
  </div>
  {% if results %}
  {% for result in results %}
    {% if not request.GET.abnormal_only or result.status != 'success' %}
  <div class="row p-2 px-lg-0 m-0 border-bottom article-list rounded-lg align-items-center position-relative">
    <div class="col-lg-8 col-md-12 col-sm-12 px-0 px-lg-3">
      <div class="row">
        <div class="col-2 text-nowrap">
          {{ result.http.account.name }}
        </div>
        <div class="col-3 px-3">
          <a href="{% url 'monitor:monitor_result' result.http.id %}?page={{ request.GET.page }}&kw={{ request.GET.kw }}" 
            class="text-dark">
          {{ result.http.label | truncatechars:20 }}
          </a>
        </div>
        <div class="col px-3">
          {{ result.http.url | truncatechars:60 }}
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-12 col-sm-12 px-0 px-lg-3">
      <div class="row justify-content-between">
        <div class="col text-center">
          {% if result.status == 'success' %}
          <span class="badge bg-success">{{ result.get_status_display }}</span>
          {% elif result.status == 'http_error' or result.status == 'keyword_not_found' or result.status == 'timeout' or result.status == 'connection_error' %}
          <button class="badge bg-danger copy-on-click border-0" onclick="copyToClipboard('{{ result.error_message|escapejs }}')" title="{{ result.error_message }}">{{ result.get_status_display }}</button>
          {% else %}
          <button class="badge bg-warning copy-on-click border-0" onclick="copyToClipboard('{{ result.error_message|escapejs }}')" title="{{ result.error_message }}">{{ result.get_status_display }}</button>
          {% endif %}
        </div>
        <div class="col text-center">
          {% if result.response_code %}
          {{ result.response_code }}
          {% else %}
          <span class="text-muted">-</span>
          {% endif %}
        </div>
        <div class="col text-center">
          {% if result.response_time %}
            {{ result.response_time|floatformat:3 }}초
          {% else %}
          <span class="text-muted">-</span>
          {% endif %}
        </div>
        <div class="col-3 text-nowrap text-lg-center order-lg-last">
          <div class="create-date" data-toggle="checked_date" data-placement="top" title="{{ result.checked_at|date:'Y-m-d H:i:s' }}">
            {{ result.checked_at|date:"m-d H:i" }}
          </div>
        </div>
      </div>
    </div>
  </div>
    {% endif %}
  {% endfor %}
  {% else %}
  <div class="py-1 mx-1">모니터링 결과가 없습니다.</div>
  {% endif %}

  <div class="mt-3">
    <!-- 페이징처리 시작 -->
    <ul class="pagination pagination-sm justify-content-center">
      <!-- 이전페이지 -->
      {% if results.has_previous %}
      <li class="page-item">
        <a class="page-link" data-page="{{ results.previous_page_number }}" href="#">이전</a>
      </li>
      {% endif %}
      <!-- 페이지리스트 -->
      {% for page_number in results.paginator.page_range %}
      {% if page_number >= results.number|add:-5 and page_number <= results.number|add:5 %}
        {% if page_number == results.number %}
        <li class="page-item active" aria-current="page">
          <a class="page-link" data-page="{{ page_number }}" href="#">{{ page_number }}</a>
        </li>
        {% else %}
        <li class="page-item">
          <a class="page-link" data-page="{{ page_number }}" href="#">{{ page_number }}</a>
        </li>
        {% endif %}
      {% endif %}
      {% endfor %}
      <!-- 다음페이지 -->
      {% if results.has_next %}
      <li class="page-item">
        <a class="page-link" data-page="{{ results.next_page_number }}" href="#">다음</a>
      </li>
      {% endif %}
    </ul>
    <!-- 페이징처리 끝 -->
  </div>
  <div class="row">
    <div class="col-9">
      <div class="input-group" style="width:200px;">
        <input type="text" class="form-control form-control-sm kw" value="{{ request.GET.kw|default_if_none:'' }}" onkeypress="if(event.key==='Enter'){$('#btn_search').click();return false;}">
        <div class="input-group-append">
          <button class="btn btn-outline-light text-secondary border-secondary border-opacity-25" type="button" id="btn_search">찾기</button>
        </div>
      </div>
    </div>
  </div>
  <form id="searchForm" method="get" action="{% if http %}{% url 'monitor:monitor_result' http.id %}{% else %}{% url 'monitor:monitor_result' %}{% endif %}">
    <input type="hidden" id="kw" name="kw" value="{{ request.GET.kw|default_if_none:'' }}">
    <input type="hidden" id="page" name="page" value="{{ request.GET.page }}">
  </form>
</div>
{% endblock %}
{% block script %}
<script type='text/javascript'>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text)
    .then(() => {
      // Create a temporary tooltip element
      const tooltip = document.createElement('div');
      tooltip.textContent = '에러 메시지가 클립보드에 복사되었습니다.';
      tooltip.style.cssText = 
        'position: fixed; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; ' +
        'border-radius: 4px; z-index: 9999; top: 50%; left: 50%; transform: translate(-50%, -50%); ' +
        'font-size: 14px; opacity: 1; transition: opacity 0.5s;';
      document.body.appendChild(tooltip);
      
      // Make tooltip disappear after 2 seconds
      setTimeout(() => {
        tooltip.style.opacity = 0;
        setTimeout(() => document.body.removeChild(tooltip), 500);
      }, 2000);
    })
    .catch(err => {
      console.error('클립보드 복사 실패:', err);
    });
}

$(document).ready(function(){
  $(".page-link").on('click', function() {
    $("#page").val($(this).data("page"));
    $("#searchForm").submit();
  });

  $("#btn_search").on('click', function() {
    $("#kw").val($(".kw").val());
    $("#page").val(1);  // 검색버튼을 클릭할 경우 1페이지부터 조회한다.
    $("#searchForm").submit();
  });

  $("#btn_abnormal_toggle").on('click', function() {
    const url = new URL(window.location.href);
    if (url.searchParams.get('abnormal_only')) {
      url.searchParams.delete('abnormal_only');
    } else {
      url.searchParams.set('abnormal_only', '1');
    }
    window.location.href = url.toString();
  });

  // 날짜에 마우스오버하면 전체일시 나오게.
  $(function () {
    $('[data-toggle="checked_date"]').tooltip()
  });
});
</script>
{% endblock %}