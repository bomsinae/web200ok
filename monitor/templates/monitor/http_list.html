{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <div class="h5">
    {% if account %}
    <a href="{% url 'cf_account:account' %}">Account</a> > {{ account.name }} 
    {% else %}
    전체
    {% endif %}
    HTTPs ({{ active_http_list }}/{{ http_list_count }}개)
  </div>
  <div>
    {% if account %}
      <a href="{% url 'monitor:http_list_excel' account.id %}{% if kw %}?kw={{ kw }}{% endif %}" class="btn btn-sm btn-success">엑셀 다운로드</a>
    {% else %}
      <a href="{% url 'monitor:http_list_excel' %}{% if kw %}?kw={{ kw }}{% endif %}" class="btn btn-sm btn-success">엑셀 다운로드</a>
    {% endif %}
  </div>
</div>
<div>
  <div class="d-none d-lg-block">
    <div class="row article-list-head py-2 m-0 rounded">
      <div class="col-lg-8">
        <div class="row">
          {% if not account %}
          <div class="col-2 text-nowrap">Account</div>
          {% endif %}
          <div class="col-3 px-3">라벨</div>    
          <div class="col">URL</div>    
        </div>
      </div>
      <div class="col-lg-4">
        <div class="row">
          <div class="col text-center text-nowrap">상태</div>
          <div class="col text-center text-nowrap">키워드</div>
          <div class="col text-center text-nowrap">응답시간</div>
          <div class="col text-center text-nowrap">사용</div>
          <div class="col-2 text-nowrap text-center">등록일</div>
          <div class="col-2 text-nowrap text-center">설정</div>
        </div>
      </div>
    </div>
  </div>
  {% if http_list %}
  <div id="sortable-list">
  {% for http in http_list %}
  <div class="row p-2 px-lg-0 m-0 border-bottom article-list rounded-lg align-items-center position-relative sortable-item" data-http-id="{{ http.id }}">
    <div class="col-lg-8 col-md-12 col-sm-12 px-0 px-lg-3">
      <div class="row">
        {% if not account %}
        <div class="col-2 text-nowrap">
          {{ http.account.name }}
        </div>
        {% endif %}
        <div class="col-3 px-3">
          <a href="{% url 'monitor:monitor_result' http.id %}?page={{ request.GET.page }}&kw={{ request.GET.kw }}" 
            class="text-dark">
          {{ http.label | truncatechars:20 }}
          </a>
        </div>
        <div class="col">
          {{ http.url | truncatechars:60 }}
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-12 col-sm-12 px-0 px-lg-3">
      <div class="row justify-content-between">
        <div class="col text-center nickname">
          {% if http.last_result %}
            {% if http.last_result.status == 'success' %}
              <span class="badge bg-success">{{ http.last_result.get_status_display }}</span>
            {% elif http.last_result.status == 'http_error' or http.last_result.status == 'keyword_not_found' or http.last_result.status == 'timeout' or http.last_result.status == 'connection_error' %}
              <span class="badge bg-danger">{{ http.last_result.get_status_display }}</span>
            {% else %}
              <span class="badge bg-warning">{{ http.last_result.get_status_display }}</span>
            {% endif %}
          {% else %}
            <span class="badge bg-secondary">미확인</span>
          {% endif %}
        </div>
        <div class="col text-center nickname">
          {%if not http.keyword %}
          <span class="badge bg-secondary">없음</span>
          {% else %}
          <span class="badge bg-primary">{{ http.keyword }}</span>
          {% endif %}
        </div>
        <div class="col text-center nickname">{{ http.max_response_time }}초</div>
        <div class="col text-center nickname">
          {% if http.is_active %}
          <span class="badge bg-success">사용</span>
          {% else %}
          <span class="badge bg-secondary">미사용</span>
          {% endif %}
        </div>
        <div class="col-2 text-nowrap text-lg-center">
          <div class="create-date" data-toggle="created_date" data-placement="top" title="{{ http.created_at|date:'Y-m-d H:i' }}">
            {% now "Y-m-d" as todays_date %}
            {% if todays_date > http.created_at|date:"Y-m-d" %}
            {{ http.created_at|date:"m-d" }}
            {% else %}
            {{ http.created_at|date:"H:i" }} 
            {% endif %}
          </div>
        </div>
        <div class="col-2 text-center">
          <a href="{% url 'cf_account:account_http_update' http.id %}">
            <span data-feather="settings"></span>
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  </div>
  {% else %}
  <div class="py-1 mx-1">등록된 URL이 없습니다.</div>
  {% endif %}

  <div class="mt-3">
    <!-- 페이징처리 시작 -->
    <ul class="pagination pagination-sm justify-content-center">
      <!-- 이전페이지 -->
      {% if http_list.has_previous %}
      <li class="page-item">
        <a class="page-link" data-page="{{ http_list.previous_page_number }}" href="#">이전</a>
      </li>
      {% endif %}
      <!-- 페이지리스트 -->
      {% for page_number in http_list.paginator.page_range %}
      {% if page_number >= http_list.number|add:-5 and page_number <= http_list.number|add:5 %}
        {% if page_number == http_list.number %}
        <li class="page-item active" aria-current="page">
          <a class="page-link" data-page="{{ page_number }}" href="#">{{ page_number }}</a>
        </li>
        {% else %}
        <li class="page-item">
          <a class="page-link" data-page="{{ page_number }}" href="#">{{ page_number }}</a>
        </li>
        {% endif %}
      {% endif %}
      {% endfor %}
      <!-- 다음페이지 -->
      {% if http_list.has_next %}
      <li class="page-item">
        <a class="page-link" data-page="{{ http_list.next_page_number }}" href="#">다음</a>
      </li>
      {% endif %}
    </ul>
    <!-- 페이징처리 끝 -->
  </div>
  <div class="row">
    <div class="col-9">
      <div class="input-group" style="width:200px;">
        <input type="text" class="form-control form-control-sm kw" value="{{ request.GET.kw|default_if_none:'' }}" onkeypress="if(event.key==='Enter'){$('#btn_search').click();return false;}">
        <div class="input-group-append">
          <button class="btn btn-outline-light text-secondary border-secondary border-opacity-25" type="button" id="btn_search">찾기</button>
        </div>
      </div>
    </div>
    {% if account %}
    <div class="col-3 d-flex justify-content-end">
      <a href="{% url 'cf_account:account_http_create' account.id %}" class="btn btn-primary">등록하기</a>
    </div>
    {% endif %}
  </div>
  {% if account %}
  <form id="searchForm" method="get" action="{% url 'cf_account:account_http_list' account.id %}">
  {% else %}
  <form id="searchForm" method="get" action="{% url 'monitor:http_list' %}">
  {% endif %}
    <input type="hidden" id="kw" name="kw" value="{{ request.GET.kw|default_if_none:'' }}">
    <input type="hidden" id="page" name="page" value="{{ request.GET.page }}">
  </form>
</div>
{% endblock %}
{% block script %}
<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script type='text/javascript'>
$(document).ready(function(){
  // 기존 페이징 및 검색 기능
  $(".page-link").on('click', function() {
    $("#page").val($(this).data("page"));
    $("#searchForm").submit();
  });

  $("#btn_search").on('click', function() {
    $("#kw").val($(".kw").val());
    $("#page").val(1);  // 검색버튼을 클릭할 경우 1페이지부터 조회한다.
    $("#searchForm").submit();
  });

  // 날짜에 마우스오버하면 전체일시 나오게.
  $(function () {
    $('[data-toggle="create_date"]').tooltip()
  });

  // 30초마다 자동 새로고침
  setInterval(function() {
    location.reload();
  }, 30000); // 30초 = 30,000 밀리초

  // 드래그 앤 드랍 기능 (첫 페이지에서만 활성화)
  {% if http_list.number == 1 %}
  const sortableList = document.getElementById('sortable-list');
  if (sortableList) {
    const sortable = Sortable.create(sortableList, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      dragClass: 'sortable-drag',
      handle: '.sortable-item', // 전체 행을 드래그 핸들로 사용
      onEnd: function (evt) {
        // 순서가 변경되었을 때 서버에 업데이트 요청
        const httpIds = [];
        $('#sortable-list .sortable-item').each(function() {
          httpIds.push($(this).data('http-id'));
        });
        
        // AJAX로 순서 업데이트
        $.ajax({
          url: '{% url "monitor:update_http_order" %}',
          method: 'POST',
          headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json',
          },
          data: JSON.stringify({
            http_ids: httpIds
          }),
          success: function(response) {
            console.log('순서가 업데이트되었습니다.');
          },
          error: function(xhr, status, error) {
            console.error('순서 업데이트 실패:', error);
            // 실패시 원래 상태로 되돌리기
            location.reload();
          }
        });
      }
    });
  }
  {% endif %}
});
</script>
<style>
/* 드래그 앤 드랍 스타일 */
.sortable-ghost {
  opacity: 0.4;
}

.sortable-chosen {
  background-color: #f8f9fa;
}

.sortable-drag {
  background-color: #e9ecef;
}

.sortable-item {
  cursor: move;
  transition: all 0.3s ease;
}

.sortable-item:hover {
  background-color: #f8f9fa;
}

/* 드래그 핸들 표시 */
.sortable-item::before {
  content: "⋮⋮";
  position: absolute;
  left: 5px;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.sortable-item:hover::before {
  opacity: 1;
}
</style>
{% endblock %}
